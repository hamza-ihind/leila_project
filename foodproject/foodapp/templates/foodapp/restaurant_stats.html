{% extends "foodapp/base.html" %}
{% load static %}

{% block title %}Statistiques | {{ restaurant.name }} | FoodFlex{% endblock %}
{% block page_title %}Statistiques du restaurant{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 24px;
        min-height: calc(100vh - 180px);
    }
    
    .sidebar {
        background-color: var(--card-bg);
        border-radius: 15px;
        padding: 24px;
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(255, 255, 255, 0.05);
        position: sticky;
        top: 100px;
        height: calc(100vh - 140px);
        overflow-y: auto;
    }
    
    .sidebar-profile {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .restaurant-image {
        width: 120px;
        height: 120px;
        border-radius: 15px;
        overflow: hidden;
        margin: 0 auto 15px;
        border: 3px solid var(--primary-color);
    }
    
    .restaurant-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .nav-link {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        margin-bottom: 8px;
        border-radius: 10px;
        color: rgba(255, 255, 255, 0.7);
        transition: all 0.3s ease;
        text-decoration: none;
    }
    
    .nav-link:hover {
        background-color: rgba(255, 107, 107, 0.1);
        color: var(--primary-color);
    }
    
    .nav-link.active {
        background-color: rgba(255, 107, 107, 0.2);
        color: var(--primary-color);
        font-weight: 600;
    }
    
    .nav-link i {
        font-size: 18px;
        width: 24px;
        text-align: center;
    }
    
    .main-content {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }
    
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 10px;
    }
    
    .stat-card {
        background-color: var(--card-bg);
        border-radius: 15px;
        padding: 24px;
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }
    
    .stat-value {
        font-size: 36px;
        font-weight: 700;
        margin-bottom: 8px;
    }
    
    .stat-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 14px;
    }
    
    .chart-container {
        background-color: var(--card-bg);
        border-radius: 15px;
        padding: 24px;
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(255, 255, 255, 0.05);
        margin-bottom: 24px;
    }
    
    .chart-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
    }
    
    .chart-wrapper {
        position: relative;
        height: 300px;
        width: 100%;
    }
    
    .data-table-container {
        background-color: var(--card-bg);
        border-radius: 15px;
        padding: 24px;
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(255, 255, 255, 0.05);
        margin-bottom: 24px;
        overflow-x: auto;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .data-table th {
        text-align: left;
        padding: 12px 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.7);
        font-weight: 500;
    }
    
    .data-table td {
        padding: 12px 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .data-table tr:hover {
        background-color: rgba(255, 255, 255, 0.02);
    }
    
    .filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .date-picker {
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 8px 15px;
        color: #fff;
        min-width: 180px;
    }
    
    .date-picker:focus {
        outline: none;
        border-color: var(--primary-color);
    }
    
    @media (max-width: 992px) {
        .dashboard-container {
            grid-template-columns: 1fr;
        }
        
        .sidebar {
            display: none;
        }
        
        .chart-grid {
            grid-template-columns: 1fr;
        }
    }
    
    @media (max-width: 768px) {
        .stats-container {
            grid-template-columns: 1fr 1fr;
        }
    }
    
    @media (max-width: 576px) {
        .stats-container {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="app-content">
    <div class="breadcrumb">
        <a href="{% url 'accueil' %}">Accueil</a>
        <span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
        <a href="{% url 'restaurant_dashboard' %}">Tableau de bord</a>
        <span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
        <span>Statistiques</span>
    </div>

    <div class="dashboard-container">
        <div class="sidebar">
            <div class="sidebar-profile">
                <div class="restaurant-image">
                    {% if restaurant.image %}
                        <img src="{{ restaurant.image.url }}" alt="{{ restaurant.name }}">
                    {% else %}
                        <img src="{% static 'foodapp/images/placeholder.jpg' %}" alt="{{ restaurant.name }}">
                    {% endif %}
                </div>
                <h3>{{ restaurant.name }}</h3>
                <div class="restaurant-meta">
                    <span>{{ restaurant.city.name }}</span>
                    <div class="status-badge {% if restaurant.is_open %}status-open{% else %}status-closed{% endif %}">
                        <i class="fas {% if restaurant.is_open %}fa-check-circle{% else %}fa-times-circle{% endif %}"></i>
                        {% if restaurant.is_open %}Ouvert{% else %}Fermé{% endif %}
                    </div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="{% url 'restaurant_dashboard' %}" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    Vue d'ensemble
                </a>
                <a href="{% url 'restaurant_orders' %}" class="nav-link">
                    <i class="fas fa-utensils"></i>
                    Commandes
                </a>
                <a href="{% url 'restaurant_menu' %}" class="nav-link">
                    <i class="fas fa-clipboard-list"></i>
                    Menu
                </a>
                <a href="{% url 'restaurant_reservations' %}" class="nav-link">
                    <i class="fas fa-calendar-alt"></i>
                    Réservations
                </a>
                <a href="{% url 'restaurant_reviews' %}" class="nav-link">
                    <i class="fas fa-star"></i>
                    Avis clients
                </a>
                <a href="{% url 'restaurant_stats' %}" class="nav-link active">
                    <i class="fas fa-chart-bar"></i>
                    Statistiques
                </a>
                <a href="{% url 'restaurant_settings' %}" class="nav-link">
                    <i class="fas fa-cog"></i>
                    Paramètres
                </a>
            </nav>
        </div>
        
        <div class="main-content">
            <h1 class="page-title">Statistiques de {{ restaurant.name }}</h1>
            
            <div class="filters">
                <select class="date-picker" id="period-select">
                    <option value="week">Cette semaine</option>
                    <option value="month" selected>Ce mois</option>
                    <option value="quarter">Trimestre</option>
                    <option value="year">Cette année</option>
                </select>
                
                <input type="date" class="date-picker" id="date-from" value="{{ start_date|date:'Y-m-d' }}">
                <input type="date" class="date-picker" id="date-to" value="{{ end_date|date:'Y-m-d' }}">
                
                <button class="btn primary-btn" id="filter-btn">
                    <i class="fas fa-filter"></i> Filtrer
                </button>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-header">
                        <h3>Chiffre d'affaires</h3>
                        <div class="stat-icon" style="background-color: rgba(52, 152, 219, 0.2); color: #3498db;">
                            <i class="fas fa-euro-sign"></i>
                        </div>
                    </div>
                    <div class="stat-value">{{ revenue }} €</div>
                    <div class="stat-label">Période sélectionnée</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <h3>Commandes</h3>
                        <div class="stat-icon" style="background-color: rgba(241, 196, 15, 0.2); color: #f1c40f;">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                    </div>
                    <div class="stat-value">{{ orders_count }}</div>
                    <div class="stat-label">Période sélectionnée</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <h3>Panier moyen</h3>
                        <div class="stat-icon" style="background-color: rgba(46, 204, 113, 0.2); color: #2ecc71;">
                            <i class="fas fa-calculator"></i>
                        </div>
                    </div>
                    <div class="stat-value">{{ avg_order_value }} €</div>
                    <div class="stat-label">Période sélectionnée</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <h3>Réservations</h3>
                        <div class="stat-icon" style="background-color: rgba(155, 89, 182, 0.2); color: #9b59b6;">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                    </div>
                    <div class="stat-value">{{ reservations_count }}</div>
                    <div class="stat-label">Période sélectionnée</div>
                </div>
            </div>
            
            <div class="chart-grid">
                <div class="chart-container">
                    <h2><i class="fas fa-chart-line"></i> Évolution du chiffre d'affaires</h2>
                    <div class="chart-wrapper">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h2><i class="fas fa-chart-bar"></i> Commandes par jour</h2>
                    <div class="chart-wrapper">
                        <canvas id="ordersChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h2><i class="fas fa-chart-pie"></i> Répartition des ventes</h2>
                    <div class="chart-wrapper">
                        <canvas id="salesDistributionChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h2><i class="fas fa-chart-pie"></i> Modes de paiement</h2>
                    <div class="chart-wrapper">
                        <canvas id="paymentMethodsChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="data-table-container">
                <h2><i class="fas fa-list-alt"></i> Performances des plats</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Plat</th>
                            <th>Quantité vendue</th>
                            <th>Chiffre d'affaires</th>
                            <th>% des ventes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dish in top_dishes %}
                            <tr>
                                <td>{{ dish.name }}</td>
                                <td>{{ dish.quantity_sold }}</td>
                                <td>{{ dish.revenue }} €</td>
                                <td>{{ dish.percentage }}%</td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">Aucune donnée disponible</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="data-table-container">
                <h2><i class="fas fa-users"></i> Clients récurrents</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Commandes</th>
                            <th>Total dépensé</th>
                            <th>Dernière visite</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in recurring_customers %}
                            <tr>
                                <td>{{ customer.name }}</td>
                                <td>{{ customer.order_count }}</td>
                                <td>{{ customer.total_spent }} €</td>
                                <td>{{ customer.last_visit }}</td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">Aucune donnée disponible</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Configuration des couleurs pour les graphiques
        const chartColors = {
            red: 'rgba(255, 99, 132, 0.7)',
            orange: 'rgba(255, 159, 64, 0.7)',
            yellow: 'rgba(255, 205, 86, 0.7)',
            green: 'rgba(75, 192, 192, 0.7)',
            blue: 'rgba(54, 162, 235, 0.7)',
            purple: 'rgba(153, 102, 255, 0.7)',
            grey: 'rgba(201, 203, 207, 0.7)'
        };
        
        // Graphique de l'évolution du chiffre d'affaires
        const revenueCtx = document.getElementById('revenueChart').getContext('2d');
        new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: {{ dates|safe }},
                datasets: [{
                    label: 'Chiffre d\'affaires (€)',
                    data: {{ revenue_data|safe }},
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    tension: 0.3,
                    pointBackgroundColor: 'rgba(54, 162, 235, 1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: 'rgba(255, 255, 255, 0.7)'
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.7)'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.7)'
                        }
                    }
                }
            }
        });
        
        // Graphique des commandes par jour
        const ordersCtx = document.getElementById('ordersChart').getContext('2d');
        new Chart(ordersCtx, {
            type: 'bar',
            data: {
                labels: {{ dates|safe }},
                datasets: [{
                    label: 'Nombre de commandes',
                    data: {{ orders_data|safe }},
                    backgroundColor: 'rgba(255, 159, 64, 0.7)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: 'rgba(255, 255, 255, 0.7)'
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.7)'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.7)'
                        }
                    }
                }
            }
        });
        
        // Graphique de répartition des ventes
        const salesDistCtx = document.getElementById('salesDistributionChart').getContext('2d');
        new Chart(salesDistCtx, {
            type: 'pie',
            data: {
                labels: {{ dish_categories|safe }},
                datasets: [{
                    data: {{ dish_categories_data|safe }},
                    backgroundColor: [
                        chartColors.red,
                        chartColors.orange,
                        chartColors.yellow,
                        chartColors.green,
                        chartColors.blue,
                        chartColors.purple
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(255, 205, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(153, 102, 255, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: 'rgba(255, 255, 255, 0.7)'
                        }
                    }
                }
            }
        });
        
        // Graphique des modes de paiement
        const paymentMethodsCtx = document.getElementById('paymentMethodsChart').getContext('2d');
        new Chart(paymentMethodsCtx, {
            type: 'doughnut',
            data: {
                labels: {{ payment_methods|safe }},
                datasets: [{
                    data: {{ payment_methods_data|safe }},
                    backgroundColor: [
                        chartColors.green,
                        chartColors.blue,
                        chartColors.purple
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(153, 102, 255, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: 'rgba(255, 255, 255, 0.7)'
                        }
                    }
                }
            }
        });
        
        // Gestion des filtres de date
        document.getElementById('period-select').addEventListener('change', function() {
            const period = this.value;
            const today = new Date();
            let startDate = new Date();
            
            // Définir la date de début en fonction de la période sélectionnée
            switch(period) {
                case 'week':
                    // Début de la semaine (lundi)
                    const dayOfWeek = today.getDay();
                    const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                    startDate.setDate(today.getDate() - diff);
                    break;
                case 'month':
                    // Début du mois
                    startDate.setDate(1);
                    break;
                case 'quarter':
                    // Début du trimestre
                    const quarter = Math.floor(today.getMonth() / 3);
                    startDate.setMonth(quarter * 3);
                    startDate.setDate(1);
                    break;
                case 'year':
                    // Début de l'année
                    startDate.setMonth(0);
                    startDate.setDate(1);
                    break;
            }
            
            // Mettre à jour les champs de date
            document.getElementById('date-from').value = formatDate(startDate);
            document.getElementById('date-to').value = formatDate(today);
        });
        
        // Formater la date pour les entrées de formulaire
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Soumettre le filtre
        document.getElementById('filter-btn').addEventListener('click', function() {
            const fromDate = document.getElementById('date-from').value;
            const toDate = document.getElementById('date-to').value;
            window.location.href = `?from=${fromDate}&to=${toDate}`;
        });
    });
</script>
{% endblock %} 