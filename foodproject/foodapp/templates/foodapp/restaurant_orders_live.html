{% extends "foodapp/base.html" %}
{% load static %}

{% block title %}Commandes en temps réel | {{ restaurant.name }} | FoodFlex{% endblock %}
{% block page_title %}Commandes en temps réel{% endblock %}

{% block extra_css %}
<style>
    /* Style différent pour la page d'affichage des commandes en temps réel */
    body {
        font-family: 'Roboto', sans-serif;
        background-color: #121212;
        color: #f5f5f5;
    }
    
    .live-orders-container {
        max-width: 100%;
        margin: 0 auto;
        padding: 20px;
    }
    
    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 15px 20px;
        background-color: #1e1e1e;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .top-bar h1 {
        font-size: 1.8rem;
        font-weight: 600;
        margin: 0;
        color: #ff6b6b;
    }
    
    .back-btn {
        padding: 8px 16px;
        background-color: transparent;
        border: 1px solid #ff6b6b;
        border-radius: 8px;
        color: #ff6b6b;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .back-btn:hover {
        background-color: rgba(255, 107, 107, 0.1);
    }
    
    .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background-color: #1e1e1e;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
        color: #ff6b6b;
    }
    
    .stat-label {
        font-size: 14px;
        color: #aaa;
    }
    
    .orders-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }
    
    .order-card {
        background-color: #1e1e1e;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .order-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }
    
    .order-header {
        padding: 15px;
        background-color: #252525;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .order-number {
        font-size: 18px;
        font-weight: 600;
    }
    
    .order-status {
        font-size: 12px;
        font-weight: 500;
        padding: 4px 12px;
        border-radius: 50px;
    }
    
    .status-new {
        background-color: rgba(52, 152, 219, 0.15);
        color: #3498db;
    }
    
    .status-preparing {
        background-color: rgba(241, 196, 15, 0.15);
        color: #f1c40f;
    }
    
    .status-ready {
        background-color: rgba(46, 204, 113, 0.15);
        color: #2ecc71;
    }
    
    .status-delivered {
        background-color: rgba(155, 89, 182, 0.15);
        color: #9b59b6;
    }
    
    .status-cancelled {
        background-color: rgba(231, 76, 60, 0.15);
        color: #e74c3c;
    }
    
    .order-content {
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .order-info {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }
    
    .order-customer {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .customer-name {
        font-size: 16px;
        font-weight: 500;
    }
    
    .order-time {
        font-size: 13px;
        color: #aaa;
    }
    
    .order-price {
        font-size: 20px;
        font-weight: 600;
        color: #ff6b6b;
    }
    
    .order-items {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .order-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .item-name {
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .item-quantity {
        background-color: rgba(255, 107, 107, 0.1);
        color: #ff6b6b;
        font-size: 12px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 4px;
    }
    
    .item-price {
        font-size: 14px;
        color: #aaa;
    }
    
    .order-footer {
        margin-top: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .order-type {
        font-size: 12px;
        padding: 4px 12px;
        border-radius: 50px;
        background-color: rgba(255, 255, 255, 0.07);
    }
    
    .order-actions {
        display: flex;
        gap: 10px;
    }
    
    .action-btn {
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
    }
    
    .primary-btn {
        background-color: #ff6b6b;
        color: white;
    }
    
    .secondary-btn {
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
    }
    
    .primary-btn:hover {
        background-color: #ff5252;
    }
    
    .secondary-btn:hover {
        background-color: rgba(255, 255, 255, 0.15);
    }
    
    /* Modal de détail de commande */
    .order-detail-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background-color: #1e1e1e;
        border-radius: 16px;
        width: 90%;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        animation: modalFadeIn 0.3s ease;
    }
    
    @keyframes modalFadeIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .modal-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        font-size: 24px;
        font-weight: 600;
        margin: 0;
    }
    
    .modal-close {
        background: none;
        border: none;
        color: #aaa;
        font-size: 24px;
        cursor: pointer;
        transition: color 0.3s ease;
    }
    
    .modal-close:hover {
        color: #ff6b6b;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .order-detail-section {
        margin-bottom: 30px;
    }
    
    .section-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #ff6b6b;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }
    
    .info-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .info-label {
        font-size: 13px;
        color: #aaa;
    }
    
    .info-value {
        font-size: 16px;
    }
    
    .item-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .detail-item {
        background-color: rgba(255, 255, 255, 0.03);
        padding: 15px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .detail-item-info {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .detail-item-name {
        font-size: 16px;
        font-weight: 500;
    }
    
    .detail-item-notes {
        font-size: 13px;
        color: #aaa;
    }
    
    .detail-item-price {
        text-align: right;
    }
    
    .price-qty {
        font-size: 14px;
        color: #aaa;
    }
    
    .price-total {
        font-size: 16px;
        font-weight: 600;
        color: #ff6b6b;
    }
    
    .order-summary {
        background-color: rgba(255, 255, 255, 0.03);
        padding: 15px;
        border-radius: 8px;
    }
    
    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }
    
    .summary-row:last-child {
        margin-bottom: 0;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .summary-label {
        font-size: 14px;
        color: #aaa;
    }
    
    .summary-value {
        font-size: 14px;
    }
    
    .summary-total {
        font-size: 18px;
        font-weight: 600;
        color: #ff6b6b;
    }
    
    .order-notes {
        background-color: rgba(255, 255, 255, 0.03);
        padding: 15px;
        border-radius: 8px;
        font-size: 14px;
        color: #aaa;
        font-style: italic;
    }
    
    .modal-footer {
        padding: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    
    .refresh-section {
        background-color: rgba(255, 107, 107, 0.05);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
    }
    
    .auto-refresh {
        font-size: 14px;
        margin-right: 10px;
        color: #aaa;
    }
    
    .refresh-btn {
        background-color: transparent;
        border: 1px solid #ff6b6b;
        color: #ff6b6b;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .refresh-btn:hover {
        background-color: rgba(255, 107, 107, 0.1);
    }
    
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 46px;
        height: 24px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #333;
        transition: .4s;
        border-radius: 34px;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
        background-color: #ff6b6b;
    }
    
    input:checked + .toggle-slider:before {
        transform: translateX(22px);
    }
    
    .category-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        overflow-x: auto;
        padding-bottom: 5px;
    }
    
    .category-tab {
        padding: 10px 20px;
        background-color: #1e1e1e;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.3s ease;
    }
    
    .category-tab.active {
        background-color: #ff6b6b;
        color: white;
    }
    
    .category-tab:hover:not(.active) {
        background-color: #252525;
    }
    
    @media (max-width: 768px) {
        .dashboard-stats {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .orders-grid {
            grid-template-columns: 1fr;
        }
        
        .info-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="live-orders-container">
    <div class="top-bar">
        <h1>Commandes en temps réel</h1>
        <a href="{% url 'restaurant_orders' %}" class="back-btn">
            <i class="fas fa-arrow-left"></i> Retour au tableau de bord
        </a>
    </div>
    
    <div class="refresh-section">
        <span class="auto-refresh">Actualisation automatique</span>
        <label class="toggle-switch">
            <input type="checkbox" id="autoRefreshToggle" checked>
            <span class="toggle-slider"></span>
        </label>
        <button class="refresh-btn" onclick="refreshOrders()">
            <i class="fas fa-sync-alt"></i> Actualiser maintenant
        </button>
    </div>
    
    <div class="dashboard-stats">
        <div class="stat-card">
            <div class="stat-value">{{ today_orders_count }}</div>
            <div class="stat-label">Commandes aujourd'hui</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ new_count }}</div>
            <div class="stat-label">Nouvelles commandes</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ preparing_count }}</div>
            <div class="stat-label">En préparation</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ ready_count }}</div>
            <div class="stat-label">Prêtes</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ today_revenue }} €</div>
            <div class="stat-label">Chiffre d'affaires du jour</div>
        </div>
    </div>
    
    <div class="category-tabs">
        <div class="category-tab active" data-category="all">Toutes les commandes</div>
        <div class="category-tab" data-category="new">Nouvelles ({{ new_count }})</div>
        <div class="category-tab" data-category="preparing">En préparation ({{ preparing_count }})</div>
        <div class="category-tab" data-category="ready">Prêtes ({{ ready_count }})</div>
        <div class="category-tab" data-category="takeaway">À emporter ({{ takeaway_count }})</div>
    </div>
    
    <div class="orders-grid" id="ordersContainer">
        {% for order in orders %}
            <div class="order-card" data-status="{{ order.status }}" data-takeaway="{{ order.is_takeaway|lower }}" onclick="showOrderDetail({{ order.id }})">
                <div class="order-header">
                    <div class="order-number">Commande #{{ order.id }}</div>
                    <div class="order-status status-{{ order.status }}">{{ order.get_status_display }}</div>
                </div>
                <div class="order-content">
                    <div class="order-info">
                        <div class="order-customer">
                            <div class="customer-name">{{ order.customer_name }}</div>
                            <div class="order-time">{{ order.order_time|date:"H:i" }}</div>
                        </div>
                        <div class="order-price">{{ order.total_amount }} €</div>
                    </div>
                    <div class="order-items">
                        {% for item in order.items.all|slice:":3" %}
                            <div class="order-item">
                                <div class="item-name">
                                    <span class="item-quantity">{{ item.quantity }}x</span>
                                    {{ item.dish.name }}
                                </div>
                                <div class="item-price">{{ item.subtotal }} €</div>
                            </div>
                        {% endfor %}
                        {% if order.items.count > 3 %}
                            <div class="order-item">
                                <div class="item-name">
                                    <i class="fas fa-ellipsis-h"></i> {{ order.items.count|add:"-3" }} article(s) de plus
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    <div class="order-footer">
                        <div class="order-type">
                            {% if order.is_takeaway %}
                                <i class="fas fa-shopping-bag"></i> À emporter
                            {% else %}
                                <i class="fas fa-utensils"></i> Sur place {% if order.table_number %}- Table {{ order.table_number }}{% endif %}
                            {% endif %}
                        </div>
                        <div class="order-actions">
                            {% if order.status == 'new' %}
                                <button class="action-btn primary-btn" onclick="updateOrderStatus({{ order.id }}, 'preparing'); event.stopPropagation();">
                                    <i class="fas fa-fire"></i> Préparer
                                </button>
                            {% elif order.status == 'preparing' %}
                                <button class="action-btn primary-btn" onclick="updateOrderStatus({{ order.id }}, 'ready'); event.stopPropagation();">
                                    <i class="fas fa-check"></i> Prête
                                </button>
                            {% elif order.status == 'ready' %}
                                <button class="action-btn primary-btn" onclick="updateOrderStatus({{ order.id }}, 'delivered'); event.stopPropagation();">
                                    <i class="fas fa-check-circle"></i> Livrée
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="empty-state">
                <i class="fas fa-clipboard-list"></i>
                <h3>Aucune commande</h3>
                <p>Les commandes apparaîtront ici dès que vous en recevrez.</p>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Modal de détail de commande -->
<div class="order-detail-modal" id="orderDetailModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Détail de la commande #<span id="detailOrderId"></span></h2>
            <button class="modal-close" onclick="closeOrderDetail()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="order-detail-section">
                <h3 class="section-title">Informations générales</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Client</div>
                        <div class="info-value" id="detailCustomerName"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Statut</div>
                        <div class="info-value" id="detailStatus"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Date et heure</div>
                        <div class="info-value" id="detailDateTime"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Type de commande</div>
                        <div class="info-value" id="detailType"></div>
                    </div>
                </div>
            </div>
            
            <div class="order-detail-section">
                <h3 class="section-title">Articles commandés</h3>
                <div class="item-list" id="detailItems">
                    <!-- Les articles seront ajoutés dynamiquement ici -->
                </div>
            </div>
            
            <div class="order-detail-section">
                <h3 class="section-title">Récapitulatif</h3>
                <div class="order-summary">
                    <div class="summary-row">
                        <div class="summary-label">Sous-total</div>
                        <div class="summary-value" id="detailSubtotal"></div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-label">TVA (10%)</div>
                        <div class="summary-value" id="detailTax"></div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-label">Total</div>
                        <div class="summary-total" id="detailTotal"></div>
                    </div>
                </div>
            </div>
            
            <div class="order-detail-section" id="notesSection" style="display: none;">
                <h3 class="section-title">Instructions spéciales</h3>
                <div class="order-notes" id="detailNotes"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="action-btn secondary-btn" onclick="closeOrderDetail()">Fermer</button>
            <div id="detailActions">
                <!-- Les actions dynamiques seront ajoutées ici -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Variables globales
    let refreshInterval;
    const refreshTime = 30000; // 30 secondes
    
    // Démarrer l'actualisation automatique
    function startAutoRefresh() {
        refreshInterval = setInterval(refreshOrders, refreshTime);
    }
    
    // Arrêter l'actualisation automatique
    function stopAutoRefresh() {
        clearInterval(refreshInterval);
    }
    
    // Actualiser les commandes
    function refreshOrders() {
        fetch('/api/restaurant/orders/')
            .then(response => response.json())
            .then(data => {
                // Mettre à jour le contenu de la page
                updateOrdersGrid(data.orders);
                updateStats(data.stats);
            })
            .catch(error => {
                console.error('Erreur lors de l\'actualisation des commandes:', error);
            });
    }
    
    // Mettre à jour la grille des commandes
    function updateOrdersGrid(orders) {
        // Cette fonction serait implémentée pour mettre à jour le contenu de la page
        // avec les nouvelles données reçues de l'API
        console.log('Mise à jour des commandes...');
    }
    
    // Mettre à jour les statistiques
    function updateStats(stats) {
        // Cette fonction serait implémentée pour mettre à jour les statistiques
        console.log('Mise à jour des statistiques...');
    }
    
    // Afficher le détail d'une commande
    function showOrderDetail(orderId) {
        fetch(`/api/restaurant/order/${orderId}/`)
            .then(response => response.json())
            .then(order => {
                // Remplir les informations générales
                document.getElementById('detailOrderId').textContent = order.id;
                document.getElementById('detailCustomerName').textContent = order.customer_name;
                document.getElementById('detailStatus').textContent = order.status_display;
                document.getElementById('detailDateTime').textContent = order.order_time;
                
                // Type de commande
                let orderType = order.is_takeaway ? 'À emporter' : 'Sur place';
                if (order.table_number && !order.is_takeaway) {
                    orderType += ` - Table ${order.table_number}`;
                }
                document.getElementById('detailType').textContent = orderType;
                
                // Articles
                const itemsContainer = document.getElementById('detailItems');
                itemsContainer.innerHTML = '';
                
                let subtotal = 0;
                
                order.items.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;
                    
                    const itemElement = document.createElement('div');
                    itemElement.className = 'detail-item';
                    
                    itemElement.innerHTML = `
                        <div class="detail-item-info">
                            <div class="detail-item-name">${item.quantity}x ${item.dish.name}</div>
                            ${item.notes ? `<div class="detail-item-notes">${item.notes}</div>` : ''}
                        </div>
                        <div class="detail-item-price">
                            <div class="price-qty">${item.price} € x ${item.quantity}</div>
                            <div class="price-total">${itemTotal.toFixed(2)} €</div>
                        </div>
                    `;
                    
                    itemsContainer.appendChild(itemElement);
                });
                
                // Récapitulatif
                const tax = subtotal * 0.1; // TVA 10%
                const total = subtotal + tax;
                
                document.getElementById('detailSubtotal').textContent = `${subtotal.toFixed(2)} €`;
                document.getElementById('detailTax').textContent = `${tax.toFixed(2)} €`;
                document.getElementById('detailTotal').textContent = `${total.toFixed(2)} €`;
                
                // Instructions spéciales
                const notesSection = document.getElementById('notesSection');
                if (order.special_instructions) {
                    document.getElementById('detailNotes').textContent = order.special_instructions;
                    notesSection.style.display = 'block';
                } else {
                    notesSection.style.display = 'none';
                }
                
                // Actions
                const actionsContainer = document.getElementById('detailActions');
                actionsContainer.innerHTML = '';
                
                if (order.status === 'new') {
                    const prepareBtn = document.createElement('button');
                    prepareBtn.className = 'action-btn primary-btn';
                    prepareBtn.innerHTML = '<i class="fas fa-fire"></i> Préparer';
                    prepareBtn.onclick = () => updateOrderStatus(order.id, 'preparing', true);
                    actionsContainer.appendChild(prepareBtn);
                } else if (order.status === 'preparing') {
                    const readyBtn = document.createElement('button');
                    readyBtn.className = 'action-btn primary-btn';
                    readyBtn.innerHTML = '<i class="fas fa-check"></i> Marquer comme prête';
                    readyBtn.onclick = () => updateOrderStatus(order.id, 'ready', true);
                    actionsContainer.appendChild(readyBtn);
                } else if (order.status === 'ready') {
                    const deliveredBtn = document.createElement('button');
                    deliveredBtn.className = 'action-btn primary-btn';
                    deliveredBtn.innerHTML = '<i class="fas fa-check-circle"></i> Marquer comme livrée';
                    deliveredBtn.onclick = () => updateOrderStatus(order.id, 'delivered', true);
                    actionsContainer.appendChild(deliveredBtn);
                }
                
                // Afficher le modal
                document.getElementById('orderDetailModal').style.display = 'flex';
            })
            .catch(error => {
                console.error('Erreur lors de la récupération des détails de la commande:', error);
            });
    }
    
    // Fermer le détail d'une commande
    function closeOrderDetail() {
        document.getElementById('orderDetailModal').style.display = 'none';
    }
    
    // Mettre à jour le statut d'une commande
    function updateOrderStatus(orderId, newStatus, closeModal = false) {
        fetch('/api/restaurant/order/update-status/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                order_id: orderId,
                status: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (closeModal) {
                    closeOrderDetail();
                }
                // Actualiser les commandes pour refléter le changement
                refreshOrders();
            } else {
                alert('Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erreur lors de la mise à jour du statut:', error);
        });
    }
    
    // Gestionnaires d'événements au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        // Gestion de l'actualisation automatique
        const autoRefreshToggle = document.getElementById('autoRefreshToggle');
        
        if (autoRefreshToggle.checked) {
            startAutoRefresh();
        }
        
        autoRefreshToggle.addEventListener('change', function() {
            if (this.checked) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });
        
        // Gestion des onglets de catégorie
        const categoryTabs = document.querySelectorAll('.category-tab');
        const orderCards = document.querySelectorAll('.order-card');
        
        categoryTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Retirer la classe active de tous les onglets
                categoryTabs.forEach(t => t.classList.remove('active'));
                
                // Ajouter la classe active à l'onglet cliqué
                this.classList.add('active');
                
                // Récupérer la catégorie
                const category = this.getAttribute('data-category');
                
                // Filtrer les commandes
                orderCards.forEach(card => {
                    if (category === 'all') {
                        card.style.display = 'block';
                    } else if (category === 'takeaway') {
                        if (card.getAttribute('data-takeaway') === 'true') {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    } else {
                        if (card.getAttribute('data-status') === category) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    }
                });
            });
        });
    });
</script>
{% endblock %} 